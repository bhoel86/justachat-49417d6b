# JAC IRC Proxy - Docker Compose with Auto-SSL
# 
# Automatic Let's Encrypt certificate provisioning and renewal.
#
# FIRST TIME SETUP:
#   1. Edit .env file with your domain and email
#   2. Run: docker-compose up -d
#   3. Get initial certificate: docker-compose run --rm certbot
#   4. Restart proxy: docker-compose restart irc-proxy
#
# MANUAL RENEWAL (if needed):
#   docker-compose run --rm certbot renew
#
# VIEW LOGS:
#   docker-compose logs -f irc-proxy
#
# STOP:
#   docker-compose down

version: '3.8'

services:
  # Main IRC Proxy
  irc-proxy:
    build: .
    container_name: jac-irc-proxy
    restart: unless-stopped
    ports:
      - "6667:6667"
      - "6697:6697"
    environment:
      - HOST=0.0.0.0
      - PORT=6667
      - SSL_ENABLED=${SSL_ENABLED:-true}
      - SSL_PORT=6697
      - SSL_CERT=/certs/live/${DOMAIN:-localhost}/fullchain.pem
      - SSL_KEY=/certs/live/${DOMAIN:-localhost}/privkey.pem
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - certs:/certs:ro
    depends_on:
      - certbot
    healthcheck:
      test: ["CMD", "pgrep", "-x", "node"]
      interval: 30s
      timeout: 3s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Certbot for Let's Encrypt certificates
  certbot:
    image: certbot/certbot:latest
    container_name: jac-certbot
    volumes:
      - certs:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped

  # Initial certificate generation (run once)
  certbot-init:
    image: certbot/certbot:latest
    container_name: jac-certbot-init
    volumes:
      - certs:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    command: >
      certonly --standalone
      --non-interactive
      --agree-tos
      --email ${ACME_EMAIL:-admin@example.com}
      --domains ${DOMAIN:-localhost}
      --preferred-challenges http
    ports:
      - "80:80"
    profiles:
      - init

volumes:
  certs:
    name: jac-irc-certs
  certbot-www:
    name: jac-certbot-www
