# JAC IRC Proxy - Docker Compose with Auto-SSL & Admin API
# 
# SETUP:
#   1. Copy .env.docker to .env and configure
#   2. Get certificate: docker-compose --profile init up certbot-init
#   3. Start: docker-compose up -d
#
# ADMIN PANEL:
#   Set ADMIN_TOKEN in .env, then access via JAC Admin Panel
#   or directly at http://your-server:6680

version: '3.8'

services:
  irc-proxy:
    build: .
    container_name: jac-irc-proxy
    restart: unless-stopped
    ports:
      - "6667:6667"
      - "6697:6697"
      - "6680:6680"
    environment:
      - HOST=0.0.0.0
      - PORT=6667
      - SSL_ENABLED=${SSL_ENABLED:-true}
      - SSL_PORT=6697
      - SSL_CERT=/certs/live/${DOMAIN:-localhost}/fullchain.pem
      - SSL_KEY=/certs/live/${DOMAIN:-localhost}/privkey.pem
      - ADMIN_PORT=6680
      - ADMIN_TOKEN=${ADMIN_TOKEN:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DATA_DIR=/data
      - RATE_CONN_PER_MIN=${RATE_CONN_PER_MIN:-5}
      - RATE_MSG_PER_SEC=${RATE_MSG_PER_SEC:-10}
      - RATE_MSG_BURST=${RATE_MSG_BURST:-20}
      - RATE_AUTO_BAN=${RATE_AUTO_BAN:-3}
      - RATE_BAN_DURATION=${RATE_BAN_DURATION:-60}
      - LOG_TO_FILE=${LOG_TO_FILE:-true}
      - LOG_DIR=/logs
      - LOG_MAX_SIZE_MB=${LOG_MAX_SIZE_MB:-10}
      - LOG_MAX_FILES=${LOG_MAX_FILES:-5}
      - GEOIP_ENABLED=${GEOIP_ENABLED:-false}
      - GEOIP_MODE=${GEOIP_MODE:-block}
      - GEOIP_COUNTRIES=${GEOIP_COUNTRIES:-}
    volumes:
      - certs:/certs:ro
      - proxy-data:/data
      - proxy-logs:/logs
      - proxy-data:/data
    depends_on:
      - certbot
    healthcheck:
      test: ["CMD", "pgrep", "-x", "node"]
      interval: 30s
      timeout: 3s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  certbot:
    image: certbot/certbot:latest
    container_name: jac-certbot
    volumes:
      - certs:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped

  certbot-init:
    image: certbot/certbot:latest
    container_name: jac-certbot-init
    volumes:
      - certs:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    command: >
      certonly --standalone
      --non-interactive
      --agree-tos
      --email ${ACME_EMAIL:-admin@example.com}
      --domains ${DOMAIN:-localhost}
      --preferred-challenges http
    ports:
      - "80:80"
    profiles:
      - init

volumes:
  certs:
    name: jac-irc-certs
  certbot-www:
    name: jac-certbot-www
  proxy-data:
    name: jac-proxy-data
  proxy-logs:
    name: jac-proxy-logs
    name: jac-proxy-data
